const GITHUB_TOKEN = "";
const OWNER = "Ayan786001";
const REPO = "Praktik-CFO";
const FILE_PATH = "projects.geojson";
const BRANCH = "main";

function updateGeoJSON() {
  const sheet = SpreadsheetApp.getActive().getSheetByName("Sheet1");
  const rows = sheet.getDataRange().getValues();
  const headers = rows.shift();

  const features = rows.map(row => {
    const d = {};
    headers.forEach((h, i) => d[h] = row[i]);

    return {
      type: "Feature",
      geometry: {
        type: "Point",
        coordinates: [
          Number(String(d.lng).replace(",", ".")),
          Number(String(d.lat).replace(",", "."))
        ]
      },
      properties: {
        village: d.VILLAGE,
        district: d.DISTRICT,
        country: d.COUNTRY,
        image_url: d.image_url,
        description: d.description,
        people_helped: d.people_helped,
        date: d.date,
        built_by: d.built_by
      }
    };
  });

  const geojson = {
    type: "FeatureCollection",
    features: features
  };

const jsonString = JSON.stringify(geojson, null, 2);

const content = Utilities.base64Encode(
  Utilities.newBlob(jsonString, "application/json", "projects.geojson")
    .getBytes()
);

  const url = "https://api.github.com/repos/" +
              OWNER + "/" +
              REPO + "/contents/" +
              FILE_PATH;

  const currentResponse = UrlFetchApp.fetch(url, {
    method: "GET",
    headers: {
      Authorization: "token " + GITHUB_TOKEN,
      Accept: "application/vnd.github+json"
    }
  });

  const sha = JSON.parse(currentResponse.getContentText()).sha;

  UrlFetchApp.fetch(url, {
    method: "PUT",
    contentType: "application/json",
    headers: {
      Authorization: "token " + GITHUB_TOKEN,
      Accept: "application/vnd.github+json"
    },
    payload: JSON.stringify({
      message: "Auto update from Google Sheets",
      content: content,
      sha: sha,
      branch: BRANCH
    })
  });
}
